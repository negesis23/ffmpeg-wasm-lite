name: Build FFmpeg WASM Ultra Lite (Cut & Mux Only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.45
          actions-cache-folder: 'emsdk-cache'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake autoconf libtool pkg-config yasm build-essential

      - name: Download FFmpeg Source
        run: |
          wget https://ffmpeg.org/releases/ffmpeg-6.0.tar.bz2
          tar xjf ffmpeg-6.0.tar.bz2
          mv ffmpeg-6.0 ffmpeg-src

      - name: Configure FFmpeg (Ultra Lite)
        run: |
          cd ffmpeg-src

          # FLAGS OPTIMASI UKURAN
          # -Oz: Optimasi agresif untuk ukuran file (Space optimization)
          # -flto: Link Time Optimization (membuang kode mati lebih baik)
          # --closure 1: Minifikasi file JavaScript
          
          COMMON_FLAGS="-s USE_PTHREADS=0 -Oz -flto"
          
          LD_FLAGS="$COMMON_FLAGS -s INITIAL_MEMORY=33554432 -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4gb -s INVOKE_RUN=0 -s EXPORTED_RUNTIME_METHODS='[\"FS\",\"main\",\"cwrap\",\"setValue\",\"getValue\"]' -s MODULARIZE=1 -s EXPORT_NAME='createFFmpegCore' -s WASM_BIGINT=1 --closure 1"

          # KONFIGURASI FFmpeg
          emconfigure ./configure \
            --target-os=none \
            --arch=x86_32 \
            --enable-cross-compile \
            --disable-x86asm \
            --disable-inline-asm \
            --disable-stripping \
            --disable-doc \
            --disable-debug \
            --disable-runtime-cpudetect \
            --disable-autodetect \
            --disable-pthreads \
            \
            --disable-everything \
            --disable-avdevice \
            --disable-avfilter \
            --disable-swscale \
            --disable-swresample \
            --disable-postproc \
            --disable-network \
            --disable-d3d11va \
            --disable-dxva2 \
            --disable-vaapi \
            --disable-vdpau \
            \
            --enable-protocol=file \
            \
            --enable-demuxer=mov,mp4,m4a,aac,mp3,matroska,webm \
            --enable-muxer=mp4,mov,matroska,webm \
            \
            --enable-parser=h264,aac,vp8,vp9,opus \
            --enable-bsf=aac_adtstoasc,h264_mp4toannexb,hevc_mp4toannexb \
            \
            --nm="emnm" \
            --ar="emar" \
            --ranlib="emranlib" \
            --cc="emcc" \
            --cxx="em++" \
            --objcc="emcc" \
            --dep-cc="emcc" \
            \
            --extra-cflags="$COMMON_FLAGS" \
            --extra-ldflags="$LD_FLAGS"

      - name: Compile Object Files
        run: |
          cd ffmpeg-src
          emmake make -j$(nproc)

      - name: Final Link (Generate JS and WASM)
        run: |
          cd ffmpeg-src
          mkdir ../dist
          
          # Linker command
          # Perhatikan: Kita menghapus -lavfilter -lswscale dll karena library itu sudah didisable di atas.
          
          emcc \
            -Oz \
            -flto \
            -s USE_PTHREADS=0 \
            -s INITIAL_MEMORY=33554432 \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s INVOKE_RUN=0 \
            -s EXPORTED_RUNTIME_METHODS='["FS","main","cwrap","setValue","getValue"]' \
            -s MODULARIZE=1 \
            -s EXPORT_NAME='createFFmpegCore' \
            -s WASM_BIGINT=1 \
            --closure 1 \
            -o ../dist/ffmpeg-core.js \
            \
            fftools/ffmpeg_opt.o fftools/ffmpeg.o fftools/cmdutils.o \
            \
            -Llibavcodec -Llibavformat -Llibavutil \
            -lavformat -lavcodec -lavutil

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-core-ultra-lite
          path: dist/
